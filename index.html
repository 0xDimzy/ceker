<script>
  async function checkPoints() {
    const address = document.getElementById('addressInput').value.trim();
    const resultDiv = document.getElementById('result');

    if (!address.startsWith("0x") || address.length !== 42) {
      resultDiv.innerHTML = "<p class='error'>Invalid address. Make sure it starts with '0x' and is 42 characters long.</p>";
      return;
    }

    resultDiv.textContent = "Loading...";

    try {
      const profileRes = await fetch(`/api/check?address=${address}`);
      const profileData = await profileRes.json();

      const inviteesRes = await fetch(`/api/invitees?address=${address}&page=1&page_size=15`);
      const inviteesData = await inviteesRes.json();

      const tasksRes = await fetch(`/api/tasks?address=${address}`);
      const tasksData = await tasksRes.json();

      if (profileData.code !== 0 || inviteesData.code !== 0 || tasksData.code !== 0) {
        resultDiv.innerHTML = "<p class='error'>Failed to fetch data. Please try again later.</p>";
        return;
      }

      const user = profileData.data.user_info;
      const totalInvitees = inviteesData.data.total;
      const tasks = tasksData.data.user_tasks;

      const taskList = tasks.map(task =>
        `<li>${task.TaskName}: Completed ${task.CompleteTimes} times</li>`
      ).join("");

      resultDiv.innerHTML = `
        <p><b><strong>Address:</strong> ${user.Address}</b></p>
        <p><b><strong>Total Points:</strong> ${user.TotalPoints}</b></p>
        <p><b><strong>Task Points:</strong> ${user.TaskPoints}</b></p>
        <p><b><strong>Invite Points:</strong> ${user.InvitePoints}</b></p>
        <p><b><strong>Total Invitees:</strong> ${totalInvitees}</b></p>
        <p><b><strong>Is KOL:</strong> ${user.IsKol ? 'Yes' : 'No'}</b></p>
        <p><b><strong>Completed Tasks:</strong></b></p>
        <ul>${taskList}</ul>
      `;
    } catch (err) {
      resultDiv.innerHTML = "<p class='error'>An error occurred while fetching data.</p>";
      console.error(err);
    }
  }
</script>
